# This file is part of ModernCRecord.

# ModernCRecord is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# ModernCRecord is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Extractor_Markup.  If not, see <http://www.gnu.org/licenses/>.

# see link below for make file dependency magic
#
# http://bruno.defraine.net/techtips/makefile-auto-dependencies-with-gcc/
#
MAKE=gmake

BOOSTDIR := /extra/boost/boost-1.82_gcc-13
GCCDIR := /extra/gcc/gcc-13
GTESTDIR := /usr/local/include
UTILITYDIR := ${HOME}/projects/ModernCRecord/ARD_common_utilities
CPP := $(GCCDIR)/bin/g++
GCC := $(GCCDIR)/bin/gcc

# If no configuration is specified, "Debug" will be used
ifndef "CFG"
	CFG := Debug
endif

#	common definitions

OUTFILE := EndToEnd_Test

CFG_INC := -I${HOME}/projects/ModernCRecord/CRecord/src \
	-I$(GTESTDIR) \
	-I$(BOOSTDIR) \
	-I$(UTILITYDIR)/include

RPATH_LIB := -Wl,-rpath,$(GCCDIR)/lib64 -Wl,-rpath,$(BOOSTDIR)/lib -Wl,-rpath,/usr/local/lib

SDIR1 := .
SRCS1 := $(SDIR1)/EndToEnd_Test.cpp

# SDIR2 := ../point_figure/src
# SRCS2 := $(SDIR2)/PF_CollectDataApp.cpp  \
# 		$(SDIR2)/DDecQuad.cpp  \
# 		$(SDIR2)/Boxes.cpp \
# 		$(SDIR2)/PF_Column.cpp \
# 		$(SDIR2)/PF_Chart.cpp \
# 		$(SDIR2)/PointAndFigureDB.cpp \
# 		$(SDIR2)/PF_Signals.cpp  \
# 		$(SDIR2)/Tiingo.cpp #\
# #		$(SDIR2)/PathNameGenerator.cpp \
# #		$(SDIR2)/DailyIndexFileRetriever.cpp \
# #		$(SDIR2)/FormFileRetriever.cpp
#
# SDIR3 := $(DECIMALSRCDIR)
# SRCS3 := $(SDIR3)/decQuad.c \
# 		 $(SDIR3)/decNumber.c \
# 		 $(SDIR3)/decContext.c
#
SDIR3a := $(UTILITYDIR)/src
SRCS3a := $(SDIR3a)/utilities.cpp

# # SDIR3a := $(DECIMALSRCDIR)/bid
# SDIR3a := $(DECIMALSRCDIR)
# SRCS3a := $(SDIR3a)/decimal128.c \
# 		  $(SDIR3a)/decimal64.c
#
# SDIR4 := $(UTILITYDIR)/src
# SRCS4 := $(SDIR4)/utilities.cpp \
# 		 $(SDIR4)/calfaq.c

SRCS := $(SRCS1) $(SRCS3a)

VPATH := $(SDIR1):$(SDIR3a)


#
# Configuration: Debug
#
ifeq "$(CFG)" "Debug"

OUTDIR=Debug_e2e

# for embedding Python, get the appropriate link flags
# python3-config --ldflags
# -L/usr/lib  -lcrypt -lpthread -ldl  -lutil -lm -lm
#
CFG_LIB := -L/usr/local/lib \
		-lgtest -lgtest_main \
		-ldate-tz \
		-L/${HOME}/projects/ModernCRecord/libCRecord \
		-lCRecord \
		-L/usr/lib \
		-lfmt \
		-lspdlog \
		-lpthread \
		-lantlr4-runtime \
		-L$(BOOSTDIR)/lib \
		-L$(GCCDIR)/lib64

OBJS1=$(addprefix $(OUTDIR)/, $(addsuffix .o, $(basename $(notdir $(SRCS1)))))
# OBJS2=$(addprefix $(OUTDIR)/, $(addsuffix .o, $(basename $(notdir $(SRCS2)))))
# OBJS3=$(addprefix $(OUTDIR)/, $(addsuffix .o, $(basename $(notdir $(SRCS3)))))
OBJS3a=$(addprefix $(OUTDIR)/, $(addsuffix .o, $(basename $(notdir $(SRCS3a)))))
# OBJS4=$(addprefix $(OUTDIR)/, $(addsuffix .o, $(basename $(notdir $(SRCS4)))))

OBJS=$(OBJS1) $(OBJS3a)

DEPS=$(OBJS:.o=.d)

COMPILE=$(CPP) -c  -x c++  -O0  -g3 -std=c++2b -D_DEBUG -DBOOST_ENABLE_ASSERT_HANDLER -DBOOST_REGEX_STANDALONE -DUSE_OS_TZDB -fPIC -o $@ $(CFG_INC) $< -march=native -MMD -MP
CCOMPILE=$(GCC) -c  -O0  -g3 -D_DEBUG -fPIC -o $@ $(CFG_INC) $< -march=native -MMD -MP

LINK := $(CPP)  -g -o $(OUTFILE) $(OBJS) $(CFG_LIB) -Wl,-E $(RPATH_LIB)

endif #	DEBUG configuration

# Build rules
all: $(OUTFILE)

$(OUTDIR)/%.o : %.cpp
	$(COMPILE)

$(OUTDIR)/%.o : %.c
	$(CCOMPILE)

$(OUTFILE): $(OUTDIR) $(OBJS1) $(OBJS3a)
	$(LINK)

-include $(DEPS)

$(OUTDIR):
	mkdir -p "$(OUTDIR)"

# Rebuild this project
rebuild: cleanall all

# Clean this project
clean:
	rm -f $(OUTFILE)
	rm -f $(OBJS)
	rm -f $(OUTDIR)/*.d
	rm -f $(OUTDIR)/*.o

# Clean this project and all dependencies
cleanall: clean
